---
- name: Generate policy document
  become: no
  delegate_to: localhost
  template:
    src: SSMService-Trust.json.j2
    dest: roles/ssm/templates/SSMService-Trust.json

- name: Create IAM role
  become: no
  delegate_to: localhost
  shell: |
    aws iam create-role \
      --role-name "{{ iam_role_name }}" \
      --assume-role-policy-document file://roles/ssm/templates/SSMService-Trust.json \
      --permissions-boundary "{{ permission_boundry_arn }}"

- name: Attach policy to created role
  become: no
  delegate_to: localhost
  shell: |
    aws iam attach-role-policy \
      --role-name "{{ iam_role_name }}" \
      --policy-arn arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore

- name: Give it 5 seconds to propagte role
  pause:
    seconds: 5